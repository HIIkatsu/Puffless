<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Puffless</title>
  <meta name="theme-color" content="#f6f7fb" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --tg-vh: 100vh;

      /* base */
      --bg:#f6f7fb;
      --txt:#0f172a;
      --muted:#64748b;

      /* surfaces */
      --panel: rgba(255,255,255,.86);
      --panel2: rgba(255,255,255,.78);
      --border: rgba(15,23,42,.10);
      --shadow: 0 18px 55px rgba(15,23,42,.10);

      /* buttons */
      --btn: rgba(255,255,255,.82);
      --btnBorder: rgba(15,23,42,.10);

      /* accents */
      --accent: rgba(99,102,241,.22);
      --accent2: rgba(236,72,153,.14);

      /* chart */
      --axis: rgba(15,23,42,.12);
      --track: rgba(15,23,42,.06);

      /* radius */
      --r: 22px;

      /* no glass in dark */
      --blur: 14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color:var(--txt);
      min-height: var(--tg-vh);
      height: var(--tg-vh);
      overflow-x:hidden;
      overflow-y:auto;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      background:
        radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 58%),
        radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 58%),
        linear-gradient(180deg, var(--bg), #f3f6ff);
    }

    /* remove blue tap highlight */
    button, .miniBtn{
      -webkit-tap-highlight-color: transparent;
      tap-highlight-color: transparent;
      outline:none;
      user-select:none; -webkit-user-select:none;
    }
    button:focus{ outline:none; }
    input, select{ user-select:text; -webkit-user-select:text; }

    /* smooth theme switch */
    body, .panel, .pill, .chip, .kpi, .chartBox, button, input, select, .toast{
      transition: background-color .28s ease, color .28s ease, border-color .28s ease, box-shadow .28s ease, filter .22s ease, transform .12s ease;
    }

    .wrap{max-width:980px; margin:0 auto; padding:18px 16px 34px; min-height:var(--tg-vh);}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 2px 14px;}
    .brand .t1{font-weight:900; letter-spacing:-.4px; font-size:18px;}
    .brand .t2{font-size:12px; color:var(--muted); margin-top:3px;}
    .pill{
      padding:10px 12px; border-radius:999px;
      background: var(--panel2);
      border:1px solid var(--border);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns:1.35fr .85fr; gap:14px;}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur)) saturate(1.1);
      -webkit-backdrop-filter: blur(var(--blur)) saturate(1.1);
      overflow:hidden;
      position:relative;
    }
    .card{padding:16px}

    .title{font-size:12px; color:var(--muted); margin-bottom:10px; font-weight:650}
    .big{font-size:44px; letter-spacing:-1px; font-weight:950; line-height:1.05;}

    .sub{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background: var(--panel2);
      border:1px solid var(--border);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    button{
      border:1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    button:active{ transform: scale(.985); filter: brightness(.98); }
    button.primary{
      background: linear-gradient(135deg, rgba(99,102,241,.30), rgba(236,72,153,.18));
      border-color: rgba(99,102,241,.20);
      box-shadow: 0 16px 38px rgba(0,0,0,.12);
    }
    button.warn{
      background: linear-gradient(135deg, rgba(251,191,36,.18), rgba(239,68,68,.18));
      border-color: rgba(239,68,68,.18);
    }

    .kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;}
    .kpi{
      padding:14px; border-radius: 18px;
      background: var(--panel2);
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
    }
    .kpi .v{font-size:20px; font-weight:950}
    .kpi .l{font-size:12px; color:var(--muted); margin-top:4px}

    .form{display:flex; flex-direction:column; gap:10px; margin-top:6px;}
    label{font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: 16px;
      color:var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight:750;
    }

    .mini{font-size:12px; color:var(--muted); margin-top:12px; line-height:1.45}
    .status{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35}
    .status b{color:var(--txt)}

    .chartBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: var(--panel2);
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
    }
    .chartTop{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;}
    .chartTop .l{font-size:12px; color:var(--muted); font-weight:750}
    .chartTop .r{display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted);}
    .miniBtn{
      border:1px solid var(--border);
      background: var(--btn);
      padding: 6px 10px;
      border-radius: 12px;
      font-weight:950;
      cursor:pointer;
      line-height:1;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
    }
    .miniBtn:active{ transform: scale(.98); }

    canvas{width:100%; height:120px; display:block; border-radius: 14px;}

    .goalBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: var(--panel);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .goalLeft{display:flex; flex-direction:column; gap:2px;}
    .goalTitle{font-size:12px; color:var(--muted); font-weight:750}
    .goalValue{font-size:14px; font-weight:950}
    .goalBar{
      width: 120px;
      height: 10px;
      border-radius: 999px;
      background: var(--track);
      border:1px solid var(--border);
      overflow:hidden;
      flex:0 0 auto;
    }
    .goalFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: rgba(99,102,241,.55);
      transition: width .25s ease, background-color .25s ease;
    }

    .errBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(239,68,68,.14);
      border: 1px solid rgba(239,68,68,.22);
      color:#7f1d1d;
      font-size:12px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
    }
    .noteBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(99,102,241,.10);
      border: 1px solid rgba(99,102,241,.18);
      color:var(--txt);
      font-size:12px;
      line-height:1.35;
    }

    /* Tap tooltip (calendar card) */
    .toast{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      padding: 12px 12px;
      display:none;
      z-index: 9999;
    }
    .toastTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .toastTitle{font-weight:950; letter-spacing:-.2px;}
    .toastSmall{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="t1">Puffless</div>
        <div class="t2">Победи свои вредные привычки</div>
      </div>
      <div class="pill" id="who">offline</div>
    </header>

    <div class="grid">
      <section class="panel card">
        <div class="title">С момента последнего раза</div>
        <div class="big" id="timer">00:00:00</div>

        <div class="sub">
          <div class="chip">Лучший стрик: <b id="best">—</b></div>
          <div class="chip">Сэкономил: <b id="saved">—</b></div>
        </div>

        <div class="row">
          <button class="primary" id="btnNow" type="button">Начать сейчас</button>
          <button class="warn" id="btnSlip" type="button">Срыв</button>
          <button id="btnPuff" type="button">Затяжка</button>
        </div>

        <div class="chartBox">
          <div class="chartTop">
            <div class="l">Затяжки за 7 дней</div>
            <div class="r">
              <span id="chartHint">сегодня: 0</span>
              <button class="miniBtn" id="btnUndoPuff" type="button" title="Отменить последнюю">↩︎</button>
            </div>
          </div>
          <canvas id="chart" width="600" height="240"></canvas>

          <div class="goalBox">
            <div class="goalLeft">
              <div class="goalTitle">Цель на день</div>
              <div class="goalValue" id="goalText">—</div>
            </div>
            <div class="goalBar" aria-label="прогресс цели">
              <div class="goalFill" id="goalFill"></div>
            </div>
          </div>

          <div class="mini" id="chartScaleHint"></div>
        </div>

        <div class="status" id="status">Статус: <b>готово</b></div>
        <div class="errBox" id="err"></div>
        <div class="noteBox" id="storageNote">Сохранение: проверка…</div>
      </section>

      <aside class="panel card">
        <div class="title">Аналитика</div>
        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiPuffs">0</div>
            <div class="l">затяжек сегодня</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiSlips">0</div>
            <div class="l">срывов всего</div>
          </div>
        </div>

        <div class="title" style="margin-top:14px">Настройки</div>
        <div class="form">
          <div>
            <label>Сколько тратил в день</label>
            <input id="costPerDay" type="number" min="0" step="0.1" placeholder="например: 30" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="currency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <div>
            <label>Цель затяжек в день</label>
            <input id="goalPerDay" type="number" min="1" step="1" placeholder="например: 20" />
          </div>
          <button id="btnSaveSettings" type="button">Сохранить</button>
        </div>

        <div class="mini" id="todayLine">Сегодня: —</div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="toastTop">
      <div class="toastTitle" id="toastTitle">—</div>
      <button class="miniBtn" id="toastClose" type="button">✕</button>
    </div>
    <div class="toastSmall" id="toastText">—</div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const KEY="calm_puffless_v1";
  const $=id=>document.getElementById(id);

  const who=$("who"), errEl=$("err"), noteEl=$("storageNote");
  const undoBtn=$("btnUndoPuff");
  const toast=$("toast"), toastTitle=$("toastTitle"), toastText=$("toastText"), toastClose=$("toastClose");

  function showErr(msg){ if(!errEl) return; errEl.style.display="block"; errEl.textContent=msg; }
  function clearErr(){ if(!errEl) return; errEl.style.display="none"; errEl.textContent=""; }
  window.onerror=(m,src,line,col)=>showErr(`Ошибка JS: ${m}\n${src||""}:${line||""}:${col||""}`);

  const tg=(window.Telegram&&Telegram.WebApp)?Telegram.WebApp:null;

  function hexToRgba(hex,a){
    try{
      const h=String(hex||"").replace("#","").trim();
      const r=parseInt(h.length===3?h[0]+h[0]:h.slice(0,2),16);
      const g=parseInt(h.length===3?h[1]+h[1]:h.slice(2,4),16);
      const b=parseInt(h.length===3?h[2]+h[2]:h.slice(4,6),16);
      if([r,g,b].some(n=>Number.isNaN(n))) throw 0;
      return `rgba(${r},${g},${b},${a})`;
    }catch{ return `rgba(99,102,241,${a})`; }
  }

  function syncViewport(){
    const h=tg?tg.viewportHeight:window.innerHeight;
    document.documentElement.style.setProperty("--tg-vh",`${h}px`);
  }

  function applyTelegramTheme(){
    if(!tg) return;
    const tp=tg.themeParams||{};
    const isDark=tg.colorScheme==="dark";

    const bg=tp.bg_color || (isDark?"#0a0f1a":"#f6f7fb");
    const text=tp.text_color || (isDark?"#e5e7eb":"#0f172a");
    const hint=tp.hint_color || (isDark?"#9aa4b2":"#64748b");
    const btn=tp.button_color || "#6366f1";

    const root=document.documentElement.style;
    root.setProperty("--bg",bg);
    root.setProperty("--txt",text);
    root.setProperty("--muted",hint);

    // Светлая: мягкие акценты; Тёмная: почти плоско
    if(isDark){
      root.setProperty("--accent", hexToRgba(btn, 0.10));
      root.setProperty("--accent2", hexToRgba("#000000", 0.00));

      // Никакого стекла
      root.setProperty("--blur","0px");
      root.setProperty("--panel","#0f172a");    // solid
      root.setProperty("--panel2","#111c33");   // slightly lighter
      root.setProperty("--border","rgba(255,255,255,.10)");
      root.setProperty("--shadow","0 22px 70px rgba(0,0,0,.55)");

      root.setProperty("--btn","#121f3a");
      root.setProperty("--btnBorder","rgba(255,255,255,.10)");

      root.setProperty("--axis","rgba(255,255,255,.14)");
      root.setProperty("--track","rgba(255,255,255,.07)");

      document.body.style.background =
        `radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 65%),
         linear-gradient(180deg, var(--bg), #05070d)`;
    } else {
      root.setProperty("--accent", hexToRgba(btn, 0.22));
      root.setProperty("--accent2", "rgba(236,72,153,.14)");

      root.setProperty("--blur","14px");
      root.setProperty("--panel","rgba(255,255,255,.86)");
      root.setProperty("--panel2","rgba(255,255,255,.78)");
      root.setProperty("--border","rgba(15,23,42,.10)");
      root.setProperty("--shadow","0 18px 55px rgba(15,23,42,.10)");

      root.setProperty("--btn","rgba(255,255,255,.82)");
      root.setProperty("--btnBorder","rgba(15,23,42,.10)");

      root.setProperty("--axis","rgba(15,23,42,.12)");
      root.setProperty("--track","rgba(15,23,42,.06)");

      document.body.style.background =
        `radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 58%),
         radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 58%),
         linear-gradient(180deg, var(--bg), #f3f6ff)`;
    }

    try{ tg.setHeaderColor("bg_color"); }catch{}
    try{ tg.setBackgroundColor(bg); }catch{}
  }

  function haptic(kind="light"){
    if(tg && tg.HapticFeedback){
      try{ tg.HapticFeedback.impactOccurred(kind); return; }catch{}
      try{ tg.HapticFeedback.notificationOccurred("success"); return; }catch{}
    }
    if(navigator.vibrate){
      const ms = kind==="heavy"?35:kind==="medium"?22:12;
      navigator.vibrate(ms);
    }
  }

  if(tg){
    tg.ready(); tg.expand();
    syncViewport(); applyTelegramTheme();
    tg.onEvent("viewportChanged", syncViewport);
    tg.onEvent("themeChanged", applyTelegramTheme);
  }else{
    syncViewport(); window.addEventListener("resize", syncViewport);
  }
  if(who) who.textContent = tg ? "online" : "online";

  // storage safe
  const mem=new Map(); let storageOk=true;
  const safeGet=k=>{ try{return localStorage.getItem(k);}catch{storageOk=false; return mem.get(k)??null;} };
  const safeSet=(k,v)=>{ try{localStorage.setItem(k,v);}catch{storageOk=false; mem.set(k,v);} };

  function dayKey(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function load(){
    try{ const raw=safeGet(KEY); return raw?JSON.parse(raw):null; }
    catch(e){ storageOk=false; showErr("Не удалось прочитать сохранение: "+(e.message||e)); return null; }
  }

  const state = load() || {
    quit_at:null,
    streak_best_seconds:0,
    cost_per_day:0,
    currency:"EUR",
    goal_per_day:20,
    slips_total:0,
    puffs:[], // [{t:iso}]
    slips:[], // [{t:iso,note}]
    last_open_day: dayKey(new Date())
  };

  function save(){
    safeSet(KEY, JSON.stringify(state));
    if(noteEl) noteEl.textContent = storageOk ? "Сохранение: OK" : "Сохранение: недоступно (временно)";
  }

  const todayK=dayKey(new Date());
  if(state.last_open_day!==todayK){ state.last_open_day=todayK; save(); }

  $("costPerDay").value = state.cost_per_day || "";
  $("currency").value = state.currency || "EUR";
  $("goalPerDay").value = state.goal_per_day || 20;

  const fmtDuration=(sec)=>{
    sec=Math.max(0,Math.floor(sec));
    const d=Math.floor(sec/86400);
    const h=Math.floor((sec%86400)/3600);
    const m=Math.floor((sec%3600)/60);
    const s=sec%60;
    const hh=String(h).padStart(2,"0"), mm=String(m).padStart(2,"0"), ss=String(s).padStart(2,"0");
    return d>0 ? `${d}д ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
  };

  function moneySaved(){
    if(!state.quit_at) return 0;
    const diff=Date.now()-Date.parse(state.quit_at);
    if(diff<=0) return 0;
    const days=diff/(1000*60*60*24);
    return days*(Number(state.cost_per_day)||0);
  }
  function moneyFormat(amount,cur){
    const n=Number(amount||0);
    const fixed=n<100?n.toFixed(2):n.toFixed(0);
    return `${fixed} ${cur}`;
  }
  const setStatus=(t)=>$("status").innerHTML = `Статус: <b>${t}</b>`;

  const puffsToday=()=>{
    const tk=dayKey(new Date());
    return (state.puffs||[]).filter(x=>dayKey(new Date(x.t))===tk).length;
  };

  function puffsLast7Days(){
    const out=[], now=new Date();
    for(let i=6;i>=0;i--){
      const d=new Date(now); d.setDate(now.getDate()-i);
      const k=dayKey(d);
      const c=(state.puffs||[]).filter(x=>dayKey(new Date(x.t))===k).length;
      out.push({ key:k, date:d, count:c });
    }
    return out; // [{key,date,count}] oldest->today
  }

  function roundRect(ctx,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function barGradient(ctx,y,h,v,isDark){
    let top,bottom;
    if(v<=10){
      top=isDark?"rgba(99,102,241,.60)":"rgba(99,102,241,.52)";
      bottom=isDark?"rgba(236,72,153,.22)":"rgba(236,72,153,.18)";
    }else if(v<=20){
      top=isDark?"rgba(251,191,36,.62)":"rgba(251,191,36,.54)";
      bottom=isDark?"rgba(239,68,68,.24)":"rgba(239,68,68,.18)";
    }else{
      top=isDark?"rgba(239,68,68,.72)":"rgba(239,68,68,.60)";
      bottom=isDark?"rgba(127,29,29,.34)":"rgba(127,29,29,.22)";
    }
    const g=ctx.createLinearGradient(0,y,0,y+Math.max(1,h));
    g.addColorStop(0,top); g.addColorStop(1,bottom);
    return g;
  }

  // chart animation + hitboxes
  let lastHeights=null, hitboxes=null, animRAF=null;

  function scaleMaxFrom(dataCounts){
    const maxVal=Math.max(0,...dataCounts);
    const rounded=Math.ceil(maxVal/10)*10;
    return Math.max(40, rounded||40); // делает 1–10 маленькими
  }

  function drawChartAnimated(){
    const c=$("chart"); if(!c||!c.getContext) return;
    const ctx=c.getContext("2d");
    const w=c.width, h=c.height;

    const isDark = tg ? (tg.colorScheme==="dark") : false;
    const data=puffsLast7Days(); // objects
    const counts=data.map(x=>x.count);
    const scaleMax=scaleMaxFrom(counts);

    const pad=22, innerW=w-pad*2, innerH=h-pad*2, gap=10;
    const barW=(innerW-gap*6)/7;

    const target=counts.map(v => (Math.max(0,v)/scaleMax)*innerH);
    if(!lastHeights) lastHeights = target.map(()=>0);

    const start=lastHeights.slice();
    const startTs=performance.now(), dur=320;

    const axis=getComputedStyle(document.documentElement).getPropertyValue("--axis").trim()||"rgba(15,23,42,.12)";
    const track=getComputedStyle(document.documentElement).getPropertyValue("--track").trim()||"rgba(15,23,42,.06)";

    hitboxes=[];
    if(animRAF) cancelAnimationFrame(animRAF);

    const frame=(t)=>{
      const k=Math.min(1,(t-startTs)/dur);
      const e=1-Math.pow(1-k,3);

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle=track;
      roundRect(ctx,0,0,w,h,16); ctx.fill();

      ctx.strokeStyle=axis; ctx.lineWidth=1;
      ctx.beginPath();
      ctx.moveTo(pad,pad+innerH);
      ctx.lineTo(pad+innerW,pad+innerH);
      ctx.stroke();

      for(let i=0;i<7;i++){
        const v=counts[i];
        const bh=start[i]+(target[i]-start[i])*e;
        const x=pad + i*(barW+gap);
        const y=pad + innerH - bh;

        // hitbox full column area
        hitboxes.push({ i, x, y: pad, w: barW, h: innerH });

        // base pill
        ctx.fillStyle=isDark?"rgba(255,255,255,.05)":"rgba(15,23,42,.04)";
        roundRect(ctx, x, pad+innerH-6, barW, 6, 6); ctx.fill();

        if(bh>0.8){
          ctx.fillStyle = barGradient(ctx,y,bh,v,isDark);
          roundRect(ctx,x,y,barW,bh,10);
          ctx.fill();
        }
      }

      if(k<1) animRAF=requestAnimationFrame(frame);
      else{ lastHeights=target.slice(); animRAF=null; }
    };

    animRAF=requestAnimationFrame(frame);
  }

  function showToast(title, text){
    if(!toast) return;
    toastTitle.textContent = title;
    toastText.textContent = text;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ toast.style.display="none"; }, 2600);
  }
  if(toastClose) toastClose.addEventListener("click", ()=>toast.style.display="none");

  function updateGoalUI(todayCount){
    const goal = Math.max(1, Number(state.goal_per_day||20));
    const pct = Math.min(1, todayCount / goal);
    $("goalText").textContent = `${todayCount} / ${goal}`;

    const fill = $("goalFill");
    fill.style.width = `${Math.round(pct*100)}%`;

    // цвет прогресса: спокойно / предупреждение / риск
    if(todayCount <= 10){
      fill.style.backgroundColor = "rgba(99,102,241,.55)";
    }else if(todayCount <= 20){
      fill.style.backgroundColor = "rgba(251,191,36,.65)";
    }else{
      fill.style.backgroundColor = "rgba(239,68,68,.70)";
    }
  }

  function render(){
    if(!state.quit_at) $("timer").textContent="00:00:00";
    $("best").textContent = fmtDuration(state.streak_best_seconds||0);
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);

    const pt=puffsToday();
    $("kpiPuffs").textContent=String(pt);
    $("kpiSlips").textContent=String(state.slips_total||0);
    $("todayLine").textContent = `Сегодня: затяжек ${pt} • экономия ~ ${moneyFormat(moneySaved(), state.currency)}`;
    $("chartHint").textContent = `сегодня: ${pt}`;

    if(undoBtn){
      undoBtn.style.opacity = pt>0 ? "1" : ".35";
      undoBtn.disabled = pt<=0;
    }

    updateGoalUI(pt);
    drawChartAnimated();
    save();
  }

  function tick(){
    if(!state.quit_at) return;
    const sec=Math.max(0, Math.floor((Date.now()-Date.parse(state.quit_at))/1000));
    $("timer").textContent=fmtDuration(sec);
    if(sec>(state.streak_best_seconds||0)){ state.streak_best_seconds=sec; save(); $("best").textContent=fmtDuration(sec); }
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);
  }

  // interactions
  $("btnNow").addEventListener("click", ()=>{
    clearErr(); haptic("light");
    state.quit_at=new Date().toISOString();
    save(); setStatus("старт установлен"); render();
  });

  $("btnSaveSettings").addEventListener("click", ()=>{
    clearErr(); haptic("light");
    state.cost_per_day = Number($("costPerDay").value||0);
    state.currency = $("currency").value||"EUR";
    state.goal_per_day = Math.max(1, Number($("goalPerDay").value||20));
    save(); setStatus("настройки сохранены"); render();
  });

  $("btnPuff").addEventListener("click", ()=>{
    clearErr(); haptic("light");
    state.puffs=state.puffs||[];
    state.puffs.push({t:new Date().toISOString()});
    save(); setStatus("затяжка записана"); render();
  });

  if(undoBtn){
    undoBtn.addEventListener("click", ()=>{
      clearErr();
      if(!state.puffs||!state.puffs.length) return;
      const tk=dayKey(new Date());
      for(let i=state.puffs.length-1;i>=0;i--){
        if(dayKey(new Date(state.puffs[i].t))===tk){
          haptic("medium");
          state.puffs.splice(i,1);
          save(); setStatus("последняя затяжка отменена"); render();
          return;
        }
      }
    });
  }

  $("btnSlip").addEventListener("click", ()=>{
    clearErr(); haptic("heavy");
    const note=prompt("Причина срыва","")||"";
    state.slips_total=Number(state.slips_total||0)+1;
    state.slips=state.slips||[];
    state.slips.push({t:new Date().toISOString(), note: note.slice(0,200)});
    const reset=confirm("Сбросить таймер (последний раз = сейчас)?");
    if(reset) state.quit_at=new Date().toISOString();
    save(); setStatus("событие сохранено"); render();
  });

  // Tap bar -> calendar-like info
  const chart=$("chart");
  if(chart){
    chart.addEventListener("click", (e)=>{
      if(!hitboxes) return;
      const rect=chart.getBoundingClientRect();
      const sx=(e.clientX-rect.left) * (chart.width/rect.width);
      const sy=(e.clientY-rect.top) * (chart.height/rect.height);

      const hb = hitboxes.find(h => sx>=h.x && sx<=h.x+h.w && sy>=h.y && sy<=h.y+h.h);
      if(!hb) return;

      const data=puffsLast7Days();
      const item=data[hb.i];
      const dd = item.date;
      const label = dd.toLocaleDateString("ru-RU",{weekday:"short", day:"2-digit", month:"2-digit"});
      haptic("light");
      showToast(`${label}`, `Затяжек: ${item.count}\n(тапай по другим столбикам, чтобы смотреть неделю)`);
    });
  }

  // start
  render();
  setInterval(tick, 250);
});
</script>
</body>
</html>