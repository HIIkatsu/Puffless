<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Puffless</title>
  <meta name="theme-color" content="#f6f7fb" />

  <!-- Telegram Mini Apps SDK (работает по HTTPS) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --txt:#0f172a;
      --muted:#64748b;

      --stroke: rgba(15,23,42,.10);
      --edge: rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --r: 24px;

      --accent: rgba(99,102,241,.20);
      --accent2: rgba(236,72,153,.14);

      /* glass system (меняется под dark/light в JS) */
      --glassA: rgba(255,255,255,.82);
      --glassB: rgba(255,255,255,.58);
      --cardBg: rgba(255,255,255,.72);
      --chipBg: rgba(255,255,255,.70);
      --btnBg: rgba(255,255,255,.78);
      --inputBg: rgba(255,255,255,.84);

      /* tg viewport */
      --tg-vh: 100vh;

      /* chart */
      --chartTrack: rgba(15,23,42,0.06);
      --chartAxis: rgba(15,23,42,0.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color:var(--txt);

      min-height: var(--tg-vh);
      height: var(--tg-vh);

      background:
        radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 58%),
        radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 58%),
        radial-gradient(700px 520px at 50% 100%, rgba(34,197,94,.10), transparent 62%),
        linear-gradient(180deg, var(--bg), #f3f6ff);

      overflow-x:hidden;
      overflow-y:auto;

      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* subtle grain */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(0,0,0,.06), transparent 60%),
        radial-gradient(1px 1px at 30% 70%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(1px 1px at 70% 30%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(1px 1px at 90% 80%, rgba(0,0,0,.04), transparent 60%);
      opacity:.35;
      mix-blend-mode: soft-light;
      filter: blur(.2px);
    }

    /* убираем синий highlight/фокус */
    button, .x{
      -webkit-tap-highlight-color: transparent;
      tap-highlight-color: transparent;
      outline: none;
      user-select:none;
      -webkit-user-select:none;
    }
    button:focus{ outline:none; }
    input, select{ user-select:text; -webkit-user-select:text; }

    /* плавные переходы по теме */
    body, .glass, .pill, .chip, .kpi, .chartBox, button, input, select{
      transition: background-color .35s ease, color .35s ease, border-color .35s ease,
                  box-shadow .35s ease, filter .25s ease, transform .12s ease;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 34px;
      min-height: var(--tg-vh);
    }

    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 6px 2px 14px;}
    .brand .t1{font-weight:880; letter-spacing:-.4px; font-size:18px;}
    .brand .t2{font-size:12px; color:var(--muted); margin-top:3px;}
    .pill{
      padding:10px 12px; border-radius:999px;
      background: var(--cardBg);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(15,23,42,.06);
      font-size:12px; color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns: 1.35fr .85fr; gap:14px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .glass{
      background: linear-gradient(135deg, var(--glassA), var(--glassB));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
      position:relative;
    }
    .glass::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(380px 220px at 20% 10%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(420px 260px at 85% 35%, rgba(255,255,255,.62), transparent 60%),
        radial-gradient(520px 320px at 45% 120%, rgba(255,255,255,.62), transparent 60%);
      opacity:.30;
      pointer-events:none;
    }
    /* edge */
    .glass::after{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--r);
      pointer-events:none;
      border:1px solid var(--edge);
      opacity:.9;
    }

    .card{padding:16px}
    .title{font-size:12px; color:var(--muted); margin-bottom:10px}
    .big{
      font-size:44px;
      letter-spacing:-1px;
      font-weight:950;
      line-height:1.05;
    }

    .sub{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background: var(--chipBg);
      border:1px solid var(--stroke);
      user-select:none;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:none;
      background: var(--btnBg);
      border:1px solid var(--stroke);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight:850;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    button:hover{ filter: brightness(1.02); }
    button:active{
      transform: scale(.985);
      filter: brightness(.98);
    }

    button.primary{
      background: linear-gradient(135deg, rgba(99,102,241,.28), rgba(236,72,153,.18));
      box-shadow: 0 16px 40px rgba(0,0,0,.14);
    }
    button.warn{
      background: linear-gradient(135deg, rgba(251,191,36,.18), rgba(248,113,113,.22));
    }
    button.ghost{ background: var(--btnBg); }

    .kpis{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:12px;}
    .kpi{
      padding:14px; border-radius: 18px;
      background: var(--cardBg);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .kpi .v{font-size:20px; font-weight:950}
    .kpi .l{font-size:12px; color:var(--muted); margin-top:4px}

    .form{display:flex; flex-direction:column; gap:10px; margin-top: 6px;}
    label{font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      background: var(--inputBg);
      border:1px solid var(--stroke);
      border-radius: 16px;
      color:var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight:700;
    }

    .mini{font-size:12px; color:var(--muted); margin-top:12px; line-height:1.45}
    .status{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35}
    .status b{color:var(--txt)}

    /* Chart */
    .chartBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: var(--cardBg);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .chartTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom: 8px;
    }
    .chartTop .l{font-size:12px; color:var(--muted); font-weight:750}
    .chartTop .r{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .miniBtn{
      border:1px solid var(--stroke);
      background: var(--btnBg);
      padding: 6px 10px;
      border-radius: 12px;
      font-weight:900;
      cursor:pointer;
      line-height:1;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
    }
    .miniBtn:active{ transform: scale(.98); }
    canvas{width:100%; height:120px; display:block;}

    .errBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(248,113,113,.12);
      border: 1px solid rgba(248,113,113,.28);
      color:#7f1d1d;
      font-size:12px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
    }
    .noteBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(99,102,241,.10);
      border: 1px solid rgba(99,102,241,.18);
      color:var(--txt);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="t1">Puffless</div>
        <div class="t2">Telegram mini app • мягко • минималистично</div>
      </div>
      <div class="pill" id="who">offline</div>
    </header>

    <div class="grid">
      <section class="glass card">
        <div class="title">С момента последнего раза</div>
        <div class="big" id="timer">00:00:00</div>

        <div class="sub">
          <div class="chip">Лучший стрик: <b id="best">—</b></div>
          <div class="chip">Сэкономил: <b id="saved">—</b></div>
        </div>

        <div class="row">
          <button class="primary" id="btnNow" type="button">Начать сейчас</button>
          <button class="warn" id="btnSlip" type="button">Срыв</button>
          <button class="ghost" id="btnPuff" type="button">Затяжка</button>
        </div>

        <div class="chartBox">
          <div class="chartTop">
            <div class="l">Затяжки за 7 дней</div>
            <div class="r">
              <span id="chartHint">сегодня: 0</span>
              <button class="miniBtn" id="btnUndoPuff" type="button" title="Отменить последнюю">↩︎</button>
            </div>
          </div>
          <canvas id="chart" width="600" height="240"></canvas>
          <div class="mini" id="chartScaleHint" style="margin-top:10px">Шкала: 0–40 (1–10 спокойно, 10–20 предупреждение, 20+ риск)</div>
        </div>

        <div class="status" id="status">Статус: <b>готово</b></div>
        <div class="errBox" id="err"></div>
        <div class="noteBox" id="storageNote">Сохранение: проверка…</div>
      </section>

      <aside class="glass card">
        <div class="title">Аналитика</div>
        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiPuffs">0</div>
            <div class="l">затяжек сегодня</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiSlips">0</div>
            <div class="l">срывов всего</div>
          </div>
        </div>

        <div class="title" style="margin-top:14px">Настройки</div>
        <div class="form">
          <div>
            <label>Сколько тратил в день</label>
            <input id="costPerDay" type="number" min="0" step="0.1" placeholder="например 7.5" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="currency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <button id="btnSaveSettings" type="button">Сохранить</button>
        </div>

        <div class="mini" id="todayLine">Сегодня: —</div>
      </aside>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const KEY = "calm_puffless_v1";
  const $ = (id) => document.getElementById(id);

  const who = $("who");
  const errEl = $("err");
  const noteEl = $("storageNote");
  const undoBtn = $("btnUndoPuff");

  function showErr(msg){
    if (!errEl) return;
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearErr(){
    if (!errEl) return;
    errEl.style.display = "none";
    errEl.textContent = "";
  }
  window.onerror = (m, src, line, col) => {
    showErr(`Ошибка JS: ${m}\n${src || ""}:${line || ""}:${col || ""}`);
  };

  // --- Telegram integration (viewport + theme + haptics) ---
  const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;

  function hexToRgba(hex, a){
    try{
      const h = String(hex||"").replace("#","").trim();
      const r = parseInt(h.length===3 ? h[0]+h[0] : h.slice(0,2), 16);
      const g = parseInt(h.length===3 ? h[1]+h[1] : h.slice(2,4), 16);
      const b = parseInt(h.length===3 ? h[2]+h[2] : h.slice(4,6), 16);
      if ([r,g,b].some(n => Number.isNaN(n))) throw 0;
      return `rgba(${r},${g},${b},${a})`;
    }catch{
      return `rgba(99,102,241,${a})`;
    }
  }

  function syncViewport(){
    const h = tg ? tg.viewportHeight : window.innerHeight;
    document.documentElement.style.setProperty("--tg-vh", `${h}px`);
  }

  function applyTelegramTheme(){
    if (!tg) return;

    const tp = tg.themeParams || {};
    const isDark = tg.colorScheme === "dark";

    const bg = tp.bg_color || (isDark ? "#070b14" : "#f6f7fb");
    const text = tp.text_color || (isDark ? "#e5e7eb" : "#0f172a");
    const hint = tp.hint_color || (isDark ? "#9aa4b2" : "#64748b");
    const btn = tp.button_color || "#6366f1";

    const root = document.documentElement.style;
    root.setProperty("--bg", bg);
    root.setProperty("--txt", text);
    root.setProperty("--muted", hint);

    root.setProperty("--accent", hexToRgba(btn, isDark ? 0.14 : 0.18));
    root.setProperty("--accent2", hexToRgba("#ec4899", isDark ? 0.10 : 0.12));

    if (isDark) {
      root.setProperty("--glassA", "rgba(17,24,39,.78)");
      root.setProperty("--glassB", "rgba(17,24,39,.52)");
      root.setProperty("--cardBg",  "rgba(30,41,59,.62)");
      root.setProperty("--chipBg",  "rgba(30,41,59,.52)");
      root.setProperty("--btnBg",   "rgba(30,41,59,.66)");
      root.setProperty("--inputBg", "rgba(30,41,59,.60)");
      root.setProperty("--stroke",  "rgba(255,255,255,.12)");
      root.setProperty("--edge",    "rgba(255,255,255,.16)");
      root.setProperty("--shadow",  "0 20px 70px rgba(0,0,0,.45)");
      root.setProperty("--chartTrack","rgba(255,255,255,0.06)");
      root.setProperty("--chartAxis","rgba(255,255,255,0.12)");
    } else {
      root.setProperty("--glassA", "rgba(255,255,255,.82)");
      root.setProperty("--glassB", "rgba(255,255,255,.58)");
      root.setProperty("--cardBg",  "rgba(255,255,255,.72)");
      root.setProperty("--chipBg",  "rgba(255,255,255,.70)");
      root.setProperty("--btnBg",   "rgba(255,255,255,.78)");
      root.setProperty("--inputBg", "rgba(255,255,255,.84)");
      root.setProperty("--stroke",  "rgba(15,23,42,.10)");
      root.setProperty("--edge",    "rgba(255,255,255,.10)");
      root.setProperty("--shadow",  "0 18px 55px rgba(15,23,42,.10)");
      root.setProperty("--chartTrack","rgba(15,23,42,0.06)");
      root.setProperty("--chartAxis","rgba(15,23,42,0.12)");
    }

    document.body.style.background =
      `radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 58%),
       radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 58%),
       radial-gradient(700px 520px at 50% 100%, rgba(34,197,94,${isDark ? 0.06 : 0.10}), transparent 62%),
       linear-gradient(180deg, var(--bg), ${isDark ? "#050812" : "#f3f6ff"})`;

    try { tg.setHeaderColor("bg_color"); } catch {}
    try { tg.setBackgroundColor(bg); } catch {}
  }

  function haptic(kind="light"){
    // 1) Telegram haptics
    if (tg && tg.HapticFeedback) {
      try { tg.HapticFeedback.impactOccurred(kind); return; } catch {}
      try { tg.HapticFeedback.notificationOccurred("success"); return; } catch {}
    }
    // 2) Fallback Android vibration API
    if (navigator.vibrate) {
      const ms = (kind === "heavy") ? 35 : (kind === "medium") ? 22 : 12;
      navigator.vibrate(ms);
    }
  }

  if (tg){
    tg.ready();
    tg.expand();
    syncViewport();
    applyTelegramTheme();
    tg.onEvent("viewportChanged", syncViewport);
    tg.onEvent("themeChanged", applyTelegramTheme);
  } else {
    syncViewport();
    window.addEventListener("resize", syncViewport);
  }

  if (who) who.textContent = tg ? "tg ok" : "js ok";

  // --- Safe storage ---
  const mem = new Map();
  let storageOk = true;

  function safeGet(k){
    try { return localStorage.getItem(k); }
    catch(e){ storageOk = false; return mem.get(k) ?? null; }
  }
  function safeSet(k, v){
    try { localStorage.setItem(k, v); }
    catch(e){ storageOk = false; mem.set(k, v); }
  }

  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function load(){
    try{
      const raw = safeGet(KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      storageOk = false;
      showErr("Не удалось прочитать сохранение: " + (e.message || e));
      return null;
    }
  }

  const state = load() || {
    quit_at: null,
    streak_best_seconds: 0,
    cost_per_day: 0,
    currency: "EUR",
    slips_total: 0,
    puffs: [],
    slips: [],
    last_open_day: dayKey(new Date())
  };

  function save(){
    safeSet(KEY, JSON.stringify(state));
    if (noteEl){
      noteEl.textContent = storageOk
        ? "Сохранение: OK"
        : "Сохранение: недоступно (временно)";
    }
  }

  // daily marker
  const todayK = dayKey(new Date());
  if (state.last_open_day !== todayK) {
    state.last_open_day = todayK;
    save();
  }

  $("costPerDay").value = state.cost_per_day || "";
  $("currency").value = state.currency || "EUR";

  function fmtDuration(seconds) {
    seconds = Math.max(0, Math.floor(seconds));
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const ss = String(s).padStart(2,"0");
    return d > 0 ? `${d}д ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
  }

  function moneySaved(){
    if (!state.quit_at) return 0;
    const diffMs = Date.now() - Date.parse(state.quit_at);
    if (diffMs <= 0) return 0;
    const days = diffMs / (1000*60*60*24);
    return days * (Number(state.cost_per_day)||0);
  }

  function moneyFormat(amount, cur) {
    const n = Number(amount || 0);
    const fixed = n < 100 ? n.toFixed(2) : n.toFixed(0);
    return `${fixed} ${cur}`;
  }

  function setStatus(text){
    $("status").innerHTML = `Статус: <b>${text}</b>`;
  }

  function puffsToday(){
    const tk = dayKey(new Date());
    return (state.puffs||[]).filter(x => dayKey(new Date(x.t)) === tk).length;
  }

  function puffsLast7Days(){
    const out = [];
    const now = new Date();
    for (let i=6;i>=0;i--){
      const d = new Date(now);
      d.setDate(now.getDate()-i);
      const k = dayKey(d);
      const c = (state.puffs||[]).filter(x => dayKey(new Date(x.t)) === k).length;
      out.push(c);
    }
    return out;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // --- Chart: scale + colors + animation ---
  let lastChartHeights = null;
  let animRAF = null;

  function getScaleMax(data){
    // хотим чтобы 1–10 было маленьким => минимум 40
    const maxVal = Math.max(0, ...data);
    const rounded = Math.ceil(maxVal / 10) * 10;
    return Math.max(40, rounded || 40);
  }

  function barGradient(ctx, y, h, v, isDark){
    // диапазоны:
    // 0–10: спокойный (сине-розовый)
    // 10–20: предупреждение (желто-оранж)
    // 20+: риск (красный)
    let top, bottom;
    if (v <= 10){
      top = isDark ? "rgba(99,102,241,0.62)" : "rgba(99,102,241,0.54)";
      bottom = isDark ? "rgba(236,72,153,0.28)" : "rgba(236,72,153,0.22)";
    } else if (v <= 20){
      top = isDark ? "rgba(251,191,36,0.62)" : "rgba(251,191,36,0.54)";
      bottom = isDark ? "rgba(248,113,113,0.34)" : "rgba(248,113,113,0.26)";
    } else {
      top = isDark ? "rgba(239,68,68,0.72)" : "rgba(239,68,68,0.62)";
      bottom = isDark ? "rgba(127,29,29,0.38)" : "rgba(127,29,29,0.28)";
    }

    const g = ctx.createLinearGradient(0, y, 0, y + Math.max(1, h));
    g.addColorStop(0, top);
    g.addColorStop(1, bottom);
    return g;
  }

  function drawChartAnimated(data){
    const c = $("chart");
    if (!c || !c.getContext) return;
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;

    const isDark = tg ? (tg.colorScheme === "dark") : false;
    const pad = 22;
    const innerW = w - pad*2;
    const innerH = h - pad*2;
    const gap = 10;
    const barW = (innerW - gap*6) / 7;

    const scaleMax = getScaleMax(data);

    // целевые высоты
    const target = data.map(v => (Math.max(0, v) / scaleMax) * innerH);
    if (!lastChartHeights) lastChartHeights = target.map(() => 0);

    const start = lastChartHeights.slice();
    const startTs = performance.now();
    const dur = 320;

    if (animRAF) cancelAnimationFrame(animRAF);

    const cssTrack = getComputedStyle(document.documentElement).getPropertyValue("--chartTrack").trim() || "rgba(15,23,42,0.06)";
    const cssAxis = getComputedStyle(document.documentElement).getPropertyValue("--chartAxis").trim() || "rgba(15,23,42,0.12)";

    const frame = (t) => {
      const k = Math.min(1, (t - startTs) / dur);
      // easeOutCubic
      const e = 1 - Math.pow(1 - k, 3);

      ctx.clearRect(0,0,w,h);

      // track
      ctx.fillStyle = cssTrack;
      roundRect(ctx, 0, 0, w, h, 18);
      ctx.fill();

      // axis
      ctx.strokeStyle = cssAxis;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad + innerH);
      ctx.lineTo(pad + innerW, pad + innerH);
      ctx.stroke();

      for (let i=0;i<7;i++){
        const v = data[i];
        const bh = start[i] + (target[i] - start[i]) * e;
        const x = pad + i*(barW+gap);
        const y = pad + innerH - bh;

        // faint base pill even if 0
        ctx.fillStyle = isDark ? "rgba(255,255,255,0.05)" : "rgba(15,23,42,0.04)";
        roundRect(ctx, x, pad + innerH - 6, barW, 6, 6);
        ctx.fill();

        if (bh > 0.8) {
          ctx.fillStyle = barGradient(ctx, y, bh, v, isDark);
          roundRect(ctx, x, y, barW, bh, 10);
          ctx.fill();
        }
      }

      if (k < 1) {
        animRAF = requestAnimationFrame(frame);
      } else {
        lastChartHeights = target.slice();
        animRAF = null;
      }
    };

    animRAF = requestAnimationFrame(frame);
  }

  function render(){
    if (!state.quit_at) $("timer").textContent = "00:00:00";
    $("best").textContent = fmtDuration(state.streak_best_seconds || 0);
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);

    const pt = puffsToday();
    $("kpiPuffs").textContent = String(pt);
    $("kpiSlips").textContent = String(state.slips_total || 0);

    const saved = moneySaved();
    $("todayLine").textContent = `Сегодня: затяжек ${pt} • экономия ~ ${moneyFormat(saved, state.currency)}`;
    $("chartHint").textContent = `сегодня: ${pt}`;

    // undo visibility
    if (undoBtn) {
      undoBtn.style.opacity = pt > 0 ? "1" : ".35";
      undoBtn.disabled = pt <= 0;
    }

    const data = puffsLast7Days();
    drawChartAnimated(data);

    save();
  }

  function tick(){
    if (!state.quit_at) return;
    const sec = Math.max(0, Math.floor((Date.now() - Date.parse(state.quit_at)) / 1000));
    $("timer").textContent = fmtDuration(sec);

    if (sec > (state.streak_best_seconds||0)) {
      state.streak_best_seconds = sec;
      save();
      $("best").textContent = fmtDuration(state.streak_best_seconds);
    }
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);
  }

  // handlers
  $("btnNow").addEventListener("click", () => {
    clearErr();
    haptic("light");
    state.quit_at = new Date().toISOString();
    save();
    setStatus("старт установлен");
    render();
  });

  $("btnSaveSettings").addEventListener("click", () => {
    clearErr();
    haptic("light");
    state.cost_per_day = Number($("costPerDay").value || 0);
    state.currency = $("currency").value || "EUR";
    save();
    setStatus("настройки сохранены");
    render();
  });

  $("btnPuff").addEventListener("click", () => {
    clearErr();
    haptic("light");

    state.puffs = state.puffs || [];
    state.puffs.push({ t: new Date().toISOString() });

    save();
    setStatus("затяжка записана");
    render();
  });

  // Undo last puff (today only)
  if (undoBtn) {
    undoBtn.addEventListener("click", () => {
      clearErr();
      if (!state.puffs || state.puffs.length === 0) return;

      const tk = dayKey(new Date());
      // найдём последнюю затяжку "сегодня"
      for (let i = state.puffs.length - 1; i >= 0; i--){
        if (dayKey(new Date(state.puffs[i].t)) === tk) {
          haptic("medium");
          state.puffs.splice(i, 1);
          save();
          setStatus("последняя затяжка отменена");
          render();
          return;
        }
      }
    });
  }

  $("btnSlip").addEventListener("click", () => {
    clearErr();
    haptic("heavy");
    const note = prompt("Причина срыва", "") || "";
    state.slips_total = Number(state.slips_total||0) + 1;
    state.slips = state.slips || [];
    state.slips.push({ t: new Date().toISOString(), note: note.slice(0, 200) });

    const reset = confirm("Сбросить таймер (последний раз = сейчас)?");
    if (reset) state.quit_at = new Date().toISOString();

    save();
    setStatus("событие сохранено");
    render();
  });

  // init
  render();
  setInterval(tick, 250);
});
</script>
</body>
</html>
