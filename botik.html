<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Puffless</title>
  <meta name="theme-color" content="#f6f7fb" />

  <!-- Telegram Mini Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --txt:#0f172a;
      --muted:#64748b;
      --stroke: rgba(15,23,42,.10);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --r: 24px;
      --accent: rgba(99,102,241,.20);
      --accent2: rgba(236,72,153,.14);

      /* будет обновляться из TG */
      --tg-vh: 100vh;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color:var(--txt);

      /* ВАЖНО: Telegram WebView иногда даёт кривую высоту -> используем переменную */
      min-height: var(--tg-vh);
      height: var(--tg-vh);

      background:
        radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 55%),
        radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 55%),
        radial-gradient(700px 520px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #f3f6ff);

      overflow-x:hidden;
      overflow-y:auto;

      /* safe areas */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* убираем синий highlight/фокус */
    button, .x{
      -webkit-tap-highlight-color: transparent;
      tap-highlight-color: transparent;
      outline: none;
      user-select:none;
      -webkit-user-select:none;
    }
    button:focus{ outline:none; }
    input, select{ user-select:text; -webkit-user-select:text; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 34px;
      min-height: var(--tg-vh);
    }

    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 6px 2px 14px;}
    .brand .t1{font-weight:850; letter-spacing:-.3px; font-size:18px;}
    .brand .t2{font-size:12px; color:var(--muted); margin-top:3px;}
    .pill{
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.72);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(15,23,42,.06);
      font-size:12px; color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns: 1.35fr .85fr; gap:14px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .glass{
      background: linear-gradient(135deg, rgba(255,255,255,.82), rgba(255,255,255,.58));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
      position:relative;
    }
    .glass::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(380px 220px at 20% 10%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(420px 260px at 85% 35%, rgba(255,255,255,.62), transparent 60%),
        radial-gradient(520px 320px at 45% 120%, rgba(255,255,255,.62), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }

    .card{padding:16px}
    .title{font-size:12px; color:var(--muted); margin-bottom:10px}
    .big{font-size:44px; letter-spacing:-1px; font-weight:900; line-height:1.05;}

    .sub{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--stroke);
      user-select:none;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:none;
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight:800;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    button:active{transform: scale(.98)}
    button.primary{
      background: linear-gradient(135deg, rgba(99,102,241,.22), rgba(236,72,153,.16));
    }
    button.warn{
      background: linear-gradient(135deg, rgba(248,113,113,.18), rgba(251,191,36,.10));
    }
    button.ghost{ background: rgba(255,255,255,.74); }

    .kpis{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:12px;}
    .kpi{
      padding:14px; border-radius: 18px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .kpi .v{font-size:20px; font-weight:950}
    .kpi .l{font-size:12px; color:var(--muted); margin-top:4px}

    .form{display:flex; flex-direction:column; gap:10px; margin-top: 6px;}
    label{font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      background: rgba(255,255,255,.84);
      border:1px solid var(--stroke);
      border-radius: 16px;
      color:var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight:650;
    }

    .mini{font-size:12px; color:var(--muted); margin-top:12px; line-height:1.45}
    .status{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35}
    .status b{color:var(--txt)}

    .chartBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .chartTop{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 8px;}
    .chartTop .l{font-size:12px; color:var(--muted)}
    .chartTop .r{font-size:12px; color:var(--muted)}
    canvas{width:100%; height:120px; display:block;}

    .errBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(248,113,113,.12);
      border: 1px solid rgba(248,113,113,.28);
      color:#7f1d1d;
      font-size:12px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
    }
    .noteBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(99,102,241,.10);
      border: 1px solid rgba(99,102,241,.18);
      color:#1e293b;
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="t1">Puffless</div>
        <div class="t2">Telegram mini app • мягко • минималистично</div>
      </div>
      <div class="pill" id="who">offline</div>
    </header>

    <div class="grid">
      <section class="glass card">
        <div class="title">С момента последнего раза</div>
        <div class="big" id="timer">00:00:00</div>

        <div class="sub">
          <div class="chip">Лучший стрик: <b id="best">—</b></div>
          <div class="chip">Сэкономил: <b id="saved">—</b></div>
        </div>

        <div class="row">
          <button class="primary" id="btnNow" type="button">Начать сейчас</button>
          <button class="ghost" id="btnPick" type="button">Указать время</button>
          <button class="warn" id="btnSlip" type="button">Срыв</button>
          <button class="ghost" id="btnPuff" type="button">Затяжка</button>
        </div>

        <div class="chartBox">
          <div class="chartTop">
            <div class="l">Затяжки за 7 дней</div>
            <div class="r" id="chartHint">сегодня: 0</div>
          </div>
          <canvas id="chart" width="600" height="240"></canvas>
        </div>

        <div class="status" id="status">Статус: <b>готово</b></div>
        <div class="errBox" id="err"></div>
        <div class="noteBox" id="storageNote">Сохранение: проверка…</div>
      </section>

      <aside class="glass card">
        <div class="title">Аналитика</div>
        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiPuffs">0</div>
            <div class="l">затяжек сегодня</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiSlips">0</div>
            <div class="l">срывов всего</div>
          </div>
        </div>

        <div class="title" style="margin-top:14px">Настройки</div>
        <div class="form">
          <div>
            <label>Сколько тратил в день</label>
            <input id="costPerDay" type="number" min="0" step="0.1" placeholder="например 7.5" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="currency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <button id="btnSaveSettings" type="button">Сохранить</button>
        </div>

        <div class="mini" id="todayLine">Сегодня: —</div>
      </aside>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const KEY = "calm_puffless_v1";
  const $ = (id) => document.getElementById(id);

  const who = $("who");
  const errEl = $("err");
  const noteEl = $("storageNote");

  function showErr(msg){
    if (!errEl) return;
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearErr(){
    if (!errEl) return;
    errEl.style.display = "none";
    errEl.textContent = "";
  }
  window.onerror = (m, src, line, col) => {
    showErr(`Ошибка JS: ${m}\n${src || ""}:${line || ""}:${col || ""}`);
  };

  // --- Telegram integration (viewport + theme + haptics) ---
  const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;

  function hexToRgba(hex, a){
    try{
      const h = String(hex||"").replace("#","").trim();
      const r = parseInt(h.length===3 ? h[0]+h[0] : h.slice(0,2), 16);
      const g = parseInt(h.length===3 ? h[1]+h[1] : h.slice(2,4), 16);
      const b = parseInt(h.length===3 ? h[2]+h[2] : h.slice(4,6), 16);
      if ([r,g,b].some(n => Number.isNaN(n))) throw 0;
      return `rgba(${r},${g},${b},${a})`;
    }catch{
      return `rgba(99,102,241,${a})`;
    }
  }

  function syncViewport(){
    const h = tg ? tg.viewportHeight : window.innerHeight;
    document.documentElement.style.setProperty("--tg-vh", `${h}px`);
  }

  function applyTelegramTheme(){
    if (!tg) return;
    const tp = tg.themeParams || {};
    const bg = tp.bg_color || "#f6f7fb";
    const text = tp.text_color || "#0f172a";
    const hint = tp.hint_color || "#64748b";
    const btn = tp.button_color || "#6366f1";

    const root = document.documentElement.style;
    root.setProperty("--bg", bg);
    root.setProperty("--txt", text);
    root.setProperty("--muted", hint);
    root.setProperty("--stroke", "rgba(15,23,42,.10)");
    root.setProperty("--accent", hexToRgba(btn, 0.18));
    root.setProperty("--accent2", hexToRgba("#ec4899", 0.12));

    // Telegram UI chrome
    try { tg.setHeaderColor("bg_color"); } catch {}
    try { tg.setBackgroundColor(bg); } catch {}
  }

  function haptic(kind="light"){
    if (!tg || !tg.HapticFeedback) return;
    try { tg.HapticFeedback.impactOccurred(kind); } catch {}
  }

  if (tg){
    tg.ready();
    tg.expand();
    syncViewport();
    applyTelegramTheme();
    tg.onEvent("viewportChanged", syncViewport);
    tg.onEvent("themeChanged", applyTelegramTheme);
  } else {
    syncViewport();
    window.addEventListener("resize", syncViewport);
  }

  if (who) who.textContent = tg ? "tg ok" : "js ok";

  // --- Safe storage ---
  const mem = new Map();
  let storageOk = true;

  function safeGet(k){
    try { return localStorage.getItem(k); }
    catch(e){ storageOk = false; return mem.get(k) ?? null; }
  }
  function safeSet(k, v){
    try { localStorage.setItem(k, v); }
    catch(e){ storageOk = false; mem.set(k, v); }
  }

  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function load(){
    try{
      const raw = safeGet(KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      storageOk = false;
      showErr("Не удалось прочитать сохранение: " + (e.message || e));
      return null;
    }
  }

  const state = load() || {
    quit_at: null,
    streak_best_seconds: 0,
    cost_per_day: 0,
    currency: "EUR",
    slips_total: 0,
    puffs: [],
    slips: [],
    last_open_day: dayKey(new Date())
  };

  function save(){
    safeSet(KEY, JSON.stringify(state));
    if (noteEl){
      noteEl.textContent = storageOk
        ? "Сохранение: OK"
        : "Сохранение: недоступно (временно)";
    }
  }

  // daily marker
  const todayK = dayKey(new Date());
  if (state.last_open_day !== todayK) {
    state.last_open_day = todayK;
    save();
  }

  $("costPerDay").value = state.cost_per_day || "";
  $("currency").value = state.currency || "EUR";

  function fmtDuration(seconds) {
    seconds = Math.max(0, Math.floor(seconds));
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const ss = String(s).padStart(2,"0");
    return d > 0 ? `${d}д ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
  }

  function moneySaved(){
    if (!state.quit_at) return 0;
    const diffMs = Date.now() - Date.parse(state.quit_at);
    if (diffMs <= 0) return 0;
    const days = diffMs / (1000*60*60*24);
    return days * (Number(state.cost_per_day)||0);
  }

  function moneyFormat(amount, cur) {
    const n = Number(amount || 0);
    const fixed = n < 100 ? n.toFixed(2) : n.toFixed(0);
    return `${fixed} ${cur}`;
  }

  function setStatus(text){
    $("status").innerHTML = `Статус: <b>${text}</b>`;
  }

  function puffsToday(){
    const tk = dayKey(new Date());
    return (state.puffs||[]).filter(x => dayKey(new Date(x.t)) === tk).length;
  }

  function puffsLast7Days(){
    const out = [];
    const now = new Date();
    for (let i=6;i>=0;i--){
      const d = new Date(now);
      d.setDate(now.getDate()-i);
      const k = dayKey(d);
      const c = (state.puffs||[]).filter(x => dayKey(new Date(x.t)) === k).length;
      out.push(c);
    }
    return out;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawChart(){
    const c = $("chart");
    if (!c || !c.getContext) return;
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;
    ctx.clearRect(0,0,w,h);

    ctx.fillStyle = "rgba(15,23,42,0.03)";
    roundRect(ctx, 0, 0, w, h, 18);
    ctx.fill();

    const data = puffsLast7Days();
    const max = Math.max(1, ...data);
    const pad = 22;
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    ctx.strokeStyle = "rgba(15,23,42,0.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad + innerH);
    ctx.lineTo(pad + innerW, pad + innerH);
    ctx.stroke();

    const gap = 10;
    const barW = (innerW - gap*6) / 7;

    for(let i=0;i<7;i++){
      const v = data[i];
      const bh = (v/max) * innerH;
      const x = pad + i*(barW+gap);
      const y = pad + innerH - bh;

      const g = ctx.createLinearGradient(0,y,0,y+bh);
      g.addColorStop(0, "rgba(99,102,241,0.50)");
      g.addColorStop(1, "rgba(236,72,153,0.24)");
      ctx.fillStyle = g;

      roundRect(ctx, x, y, barW, bh, 10);
      ctx.fill();
    }
  }

  function render(){
    if (!state.quit_at) $("timer").textContent = "00:00:00";
    $("best").textContent = fmtDuration(state.streak_best_seconds || 0);
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);

    const pt = puffsToday();
    $("kpiPuffs").textContent = String(pt);
    $("kpiSlips").textContent = String(state.slips_total || 0);

    const saved = moneySaved();
    $("todayLine").textContent = `Сегодня: затяжек ${pt} • экономия ~ ${moneyFormat(saved, state.currency)}`;
    $("chartHint").textContent = `сегодня: ${pt}`;

    drawChart();
    save();
  }

  function tick(){
    if (!state.quit_at) return;
    const sec = Math.max(0, Math.floor((Date.now() - Date.parse(state.quit_at)) / 1000));
    $("timer").textContent = fmtDuration(sec);

    if (sec > (state.streak_best_seconds||0)) {
      state.streak_best_seconds = sec;
      save();
      $("best").textContent = fmtDuration(state.streak_best_seconds);
    }
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);
  }

  // handlers
  $("btnNow").addEventListener("click", () => {
    clearErr();
    haptic("light");
    state.quit_at = new Date().toISOString();
    save();
    setStatus("старт установлен");
    render();
  });

  $("btnPick").addEventListener("click", () => {
    clearErr();
    haptic("light");
    const raw = prompt("Введи дату/время (например 2026-02-05 12:30) или ISO:");
    if (!raw) return;

    const try1 = new Date(raw);
    if (!Number.isNaN(try1.getTime())) {
      state.quit_at = try1.toISOString();
      save();
      setStatus("время обновлено");
      render();
      return;
    }

    const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
    if (m) {
      const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]), 0);
      state.quit_at = d.toISOString();
      save();
      setStatus("время обновлено");
      render();
      return;
    }

    alert("Не понял формат. Пример: 2026-02-05 12:30");
  });

  $("btnSaveSettings").addEventListener("click", () => {
    clearErr();
    haptic("light");
    state.cost_per_day = Number($("costPerDay").value || 0);
    state.currency = $("currency").value || "EUR";
    save();
    setStatus("настройки сохранены");
    render();
  });

  $("btnPuff").addEventListener("click", () => {
    clearErr();
    haptic("light");
    state.puffs = state.puffs || [];
    state.puffs.push({ t: new Date().toISOString() });
    save();
    setStatus("затяжка записана");
    render();
  });

  $("btnSlip").addEventListener("click", () => {
    clearErr();
    haptic("medium");
    const note = prompt("Причина срыва", "") || "";
    state.slips_total = Number(state.slips_total||0) + 1;
    state.slips = state.slips || [];
    state.slips.push({ t: new Date().toISOString(), note: note.slice(0, 200) });

    const reset = confirm("Сбросить таймер (последний раз = сейчас)?");
    if (reset) state.quit_at = new Date().toISOString();

    save();
    setStatus("событие сохранено");
    render();
  });

  // init
  render();
  setInterval(tick, 250);
});
</script>
</body>
</html>
