<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Calm Puffless — Offline</title>
  <meta name="theme-color" content="#f6f7fb" />
  <style>
    :root{
      --bg:#f6f7fb;
      --txt:#0f172a;
      --muted:#64748b;
      --card: rgba(255,255,255,.68);
      --stroke: rgba(15,23,42,.10);
      --shadow: 0 18px 55px rgba(15,23,42,.10);
      --r: 24px;
      --ok: rgba(34,197,94,.18);
      --warn: rgba(248,113,113,.18);
      --accent: rgba(99,102,241,.20);
      --accent2: rgba(236,72,153,.14);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 520px at 15% 0%, var(--accent), transparent 55%),
        radial-gradient(760px 520px at 85% 10%, var(--accent2), transparent 55%),
        radial-gradient(700px 520px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #f3f6ff);
      overflow-x:hidden;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 18px 16px 34px;}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 6px 2px 14px;}
    .brand .t1{font-weight:850; letter-spacing:-.3px; font-size:18px;}
    .brand .t2{font-size:12px; color:var(--muted); margin-top:3px;}
    .pill{
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.72);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(15,23,42,.06);
      font-size:12px; color:var(--muted);
      user-select:none;
    }

    .grid{display:grid; grid-template-columns: 1.35fr .85fr; gap:14px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .glass{
      background: linear-gradient(135deg, rgba(255,255,255,.82), rgba(255,255,255,.58));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
      position:relative;
    }
    .glass::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(380px 220px at 20% 10%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(420px 260px at 85% 35%, rgba(255,255,255,.62), transparent 60%),
        radial-gradient(520px 320px at 45% 120%, rgba(255,255,255,.62), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .card{padding:16px}
    .title{font-size:12px; color:var(--muted); margin-bottom:10px}
    .big{
      font-size:44px;
      letter-spacing:-1px;
      font-weight:900;
      line-height:1.05;
    }
    .sub{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--stroke);
      user-select:none;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:none;
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight:800;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    button:active{transform: scale(.98)}
    button.primary{
      background: linear-gradient(135deg, rgba(99,102,241,.22), rgba(236,72,153,.16));
    }
    button.warn{
      background: linear-gradient(135deg, rgba(248,113,113,.18), rgba(251,191,36,.10));
    }
    button.ghost{
      background: rgba(255,255,255,.74);
    }

    .kpis{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:12px;}
    .kpi{
      padding:14px; border-radius: 18px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .kpi .v{font-size:20px; font-weight:950}
    .kpi .l{font-size:12px; color:var(--muted); margin-top:4px}

    .form{display:flex; flex-direction:column; gap:10px; margin-top: 6px;}
    label{font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      background: rgba(255,255,255,.84);
      border:1px solid var(--stroke);
      border-radius: 16px;
      color:var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight:650;
    }

    .mini{font-size:12px; color:var(--muted); margin-top:12px; line-height:1.45}
    .status{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35}
    .status b{color:var(--txt)}

    /* Bottom sheet */
    .sheetBack{
      position:fixed; inset:0;
      background: rgba(15,23,42,.25);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px;
    }
    .sheet{
      width:min(720px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 28px 80px rgba(15,23,42,.18);
      padding: 14px;
      transform: translateY(8px);
    }
    .sheetTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .grab{
      width: 52px; height: 5px; border-radius:999px;
      background: rgba(15,23,42,.10);
      margin: 0 auto 10px;
    }
    .sheetTitle{font-weight:900; letter-spacing:-.2px}
    .x{
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      cursor:pointer;
      font-weight:900;
    }

    /* Breathing ring */
    .ringWrap{display:grid; place-items:center; padding: 10px 6px 4px;}
    .ring{
      width: 180px; height: 180px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,.65) 48%, rgba(255,255,255,.30) 70%, rgba(255,255,255,0) 72%),
        radial-gradient(circle at 70% 70%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(circle at 35% 75%, rgba(236,72,153,.16), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 20px 60px rgba(15,23,42,.12);
      display:grid; place-items:center;
      transform: scale(.92);
      transition: transform 3.8s ease-in-out;
    }
    .ring.inhale{ transform: scale(1.02); }
    .ring.exhale{ transform: scale(.90); }
    .ringText{
      text-align:center;
      user-select:none;
    }
    .ringText .phase{font-weight:950; font-size:16px}
    .ringText .sec{margin-top:4px; color:var(--muted); font-weight:750}
    .sheetNote{
      margin-top: 10px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="t1">Calm Puffless</div>
        <div class="t2">офлайн • мягко • минималистично</div>
      </div>
      <div class="pill" id="who">offline</div>
    </header>

    <div class="grid">
      <section class="glass card">
        <div class="title">С момента последнего раза</div>
        <div class="big" id="timer">00:00:00</div>

        <div class="sub">
          <div class="chip">Лучший стрик: <b id="best">—</b></div>
          <div class="chip">Сэкономил: <b id="saved">—</b></div>
        </div>

        <div class="row">
          <button class="primary" id="btnNow">Начать сейчас</button>
          <button class="ghost" id="btnPick">Указать время</button>
          <button class="warn" id="btnSlip">Срыв</button>
          <button class="ghost" id="btnUrge">Тянет</button>
        </div>

        <div class="status" id="status">Статус: <b>готово</b></div>
        <div class="mini">
          Всё сохраняется в браузере (localStorage). Завтра перенесём на сервер и будет синхронизация между устройствами.
        </div>
      </section>

      <aside class="glass card">
        <div class="title">Аналитика</div>
        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiUrges">0</div>
            <div class="l">тянуло сегодня</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiSlips">0</div>
            <div class="l">срывов всего</div>
          </div>
        </div>

        <div class="title" style="margin-top:14px">Настройки</div>
        <div class="form">
          <div>
            <label>Сколько тратил в день</label>
            <input id="costPerDay" type="number" min="0" step="0.1" placeholder="например 7.5" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="currency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="RUB">RUB</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <button id="btnSaveSettings">Сохранить</button>
        </div>

        <div class="mini" id="todayLine">Сегодня: —</div>
      </aside>
    </div>
  </div>

  <!-- Anti-urge sheet -->
  <div class="sheetBack" id="sheetBack">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="grab"></div>
      <div class="sheetTop">
        <div class="sheetTitle">Переждать “волну” (2 минуты)</div>
        <div class="x" id="sheetClose">✕</div>
      </div>

      <div class="ringWrap">
        <div class="ring inhale" id="ring">
          <div class="ringText">
            <div class="phase" id="phase">Вдох</div>
            <div class="sec" id="phaseSec">4 сек</div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="primary" id="btnStartBreath">Старт</button>
        <button class="ghost" id="btnLogUrge">Записать “тянет”</button>
      </div>

      <div class="sheetNote">
        Подсказка: оцени тягу (1–10), сделай 3 цикла дыхания, выпей воды, переключись на 60 секунд.
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY = "calm_puffless_v1";

  const $ = (id) => document.getElementById(id);

  const state = load() || {
    quit_at: null,                 // ISO
    streak_best_seconds: 0,
    cost_per_day: 0,
    currency: "EUR",
    slips_total: 0,
    urges: [],                     // [{t:iso, intensity:number}]
    slips: [],                     // [{t:iso, note:string}]
    last_open_day: dayKey(new Date())
  };

  // migrate daily counters (reset urges today)
  const todayK = dayKey(new Date());
  if (state.last_open_day !== todayK) {
    state.last_open_day = todayK;
    // ничего не удаляем, просто дневные показатели считаем фильтром по дате
    save();
  }

  $("costPerDay").value = state.cost_per_day || "";
  $("currency").value = state.currency;

  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }

  function dayKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function fmtDuration(seconds) {
    seconds = Math.max(0, Math.floor(seconds));
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const ss = String(s).padStart(2,"0");
    return d > 0 ? `${d}д ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
  }

  function moneySaved(){
    if (!state.quit_at) return 0;
    const diffMs = Date.now() - Date.parse(state.quit_at);
    if (diffMs <= 0) return 0;
    const days = diffMs / (1000*60*60*24);
    return days * (Number(state.cost_per_day)||0);
  }

  function moneyFormat(amount, cur) {
    const n = Number(amount || 0);
    const fixed = n < 100 ? n.toFixed(2) : n.toFixed(0);
    return `${fixed} ${cur}`;
  }

  function setStatus(text){
    $("status").innerHTML = `Статус: <b>${text}</b>`;
  }

  function urgesToday(){
    const tk = dayKey(new Date());
    return (state.urges||[]).filter(x => dayKey(new Date(x.t)) === tk).length;
  }

  function render(){
    // timer
    if (!state.quit_at) $("timer").textContent = "00:00:00";
    // best
    $("best").textContent = fmtDuration(state.streak_best_seconds || 0);
    // saved
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);

    // KPIs
    $("kpiUrges").textContent = String(urgesToday());
    $("kpiSlips").textContent = String(state.slips_total || 0);

    // today line
    const saved = moneySaved();
    $("todayLine").textContent =
      `Сегодня: тяга ${urgesToday()} • экономия ~ ${moneyFormat(saved, state.currency)}`;
  }

  function tick(){
    if (!state.quit_at) return;
    const sec = Math.max(0, Math.floor((Date.now() - Date.parse(state.quit_at)) / 1000));
    $("timer").textContent = fmtDuration(sec);
    // best streak update
    if (sec > (state.streak_best_seconds||0)) {
      state.streak_best_seconds = sec;
      save();
      $("best").textContent = fmtDuration(state.streak_best_seconds);
    }
    // savings update
    $("saved").textContent = moneyFormat(moneySaved(), state.currency);
  }

  // Actions
  $("btnNow").addEventListener("click", () => {
    state.quit_at = new Date().toISOString();
    save();
    setStatus("старт установлен");
    render();
  });

  $("btnPick").addEventListener("click", () => {
    // мобильный-friendly: просим ISO или "YYYY-MM-DD HH:mm"
    const raw = prompt("Введи дату/время (например 2026-02-05 12:30) или ISO:");
    if (!raw) return;

    const try1 = new Date(raw);
    if (!Number.isNaN(try1.getTime())) {
      state.quit_at = try1.toISOString();
      save();
      setStatus("время обновлено");
      render();
      return;
    }

    // попытка парсинга "YYYY-MM-DD HH:mm"
    const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
    if (m) {
      const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]), 0);
      state.quit_at = d.toISOString();
      save();
      setStatus("время обновлено");
      render();
      return;
    }

    alert("Не понял формат. Пример: 2026-02-05 12:30");
  });

  $("btnSaveSettings").addEventListener("click", () => {
    state.cost_per_day = Number($("costPerDay").value || 0);
    state.currency = $("currency").value || "EUR";
    save();
    setStatus("настройки сохранены");
    render();
  });

  $("btnUrge").addEventListener("click", () => {
    openSheet();
  });

  $("btnSlip").addEventListener("click", () => {
    const note = prompt("Коротко: что случилось? (триггер/ситуация)", "стресс / компания / кофе") || "";
    state.slips_total = Number(state.slips_total||0) + 1;
    state.slips = state.slips || [];
    state.slips.push({ t: new Date().toISOString(), note: note.slice(0, 200) });
    save();

    const reset = confirm("Сбросить таймер (последний раз = сейчас)?");
    if (reset) state.quit_at = new Date().toISOString();

    save();
    setStatus("событие сохранено");
    render();
  });

  // Sheet + breathing
  const sheetBack = $("sheetBack");
  const ring = $("ring");
  const phase = $("phase");
  const phaseSec = $("phaseSec");

  function openSheet(){
    sheetBack.style.display = "flex";
  }
  function closeSheet(){
    sheetBack.style.display = "none";
    stopBreath();
  }
  $("sheetClose").addEventListener("click", closeSheet);
  sheetBack.addEventListener("click", (e) => {
    if (e.target === sheetBack) closeSheet();
  });

  let breathTimer = null;
  let step = 0; // 0 inhale, 1 hold, 2 exhale, 3 hold
  let secLeft = 0;
  const pattern = [
    { name:"Вдох", sec:4, cls:"inhale" },
    { name:"Задержка", sec:2, cls:"inhale" },
    { name:"Выдох", sec:6, cls:"exhale" },
    { name:"Пауза", sec:2, cls:"exhale" },
  ];

  function applyStep(){
    const p = pattern[step];
    phase.textContent = p.name;
    secLeft = p.sec;
    phaseSec.textContent = `${secLeft} сек`;
    ring.classList.remove("inhale","exhale");
    ring.classList.add(p.cls);
  }

  function stopBreath(){
    if (breathTimer) clearInterval(breathTimer);
    breathTimer = null;
    step = 0;
    applyStep();
  }

  function startBreath(){
    stopBreath();
    applyStep();
    breathTimer = setInterval(() => {
      secLeft -= 1;
      if (secLeft <= 0) {
        step = (step + 1) % pattern.length;
        applyStep();
      } else {
        phaseSec.textContent = `${secLeft} сек`;
      }
    }, 1000);
  }

  $("btnStartBreath").addEventListener("click", () => {
    startBreath();
  });

  $("btnLogUrge").addEventListener("click", () => {
    const intensity = Number(prompt("Насколько сильно тянет (1–10)?", "6") || "6");
    const val = Math.max(1, Math.min(10, intensity || 6));
    state.urges = state.urges || [];
    state.urges.push({ t: new Date().toISOString(), intensity: val });
    save();
    setStatus("записано (ты справишься)");
    render();
  });

  // First render
  render();
  setInterval(tick, 250);

})();
</script>
</body>
</html>